<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tropico Ventures IOT</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0f172a;
        color: #e5e7eb;
        margin: 0;
        padding: 1.5rem;
      }
      h1 {
        margin-bottom: 0.5rem;
      }
      h2 {
        font-size: 0.9rem;
        font-weight: 400;
        line-height: 1.4;
        color: #9ca3af;
        max-width: 60rem;
      }
      .grid {
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
      }
      .card {
        background: #111827;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);
        border: 1px solid #1f2937;
      }
      .card h3 {
        margin-top: 0;
        margin-bottom: 0.75rem;
        font-size: 1.05rem;
      }
      .metric {
        font-size: 0.95rem;
        margin: 0.25rem 0;
      }
      .metric span.value {
        font-weight: 600;
        font-size: 1.1rem;
        color: #fbbf24;
      }
      .metric span.unit {
        font-size: 0.8rem;
        color: #9ca3af;
      }
      .timer-bar {
        position: relative;
        height: 8px;
        border-radius: 999px;
        background: #1f2937;
        overflow: hidden;
        margin-top: 0.5rem;
      }
      .timer-bar-fill {
        position: absolute;
        inset: 0;
        width: 0%;
        background: linear-gradient(90deg, #22c55e, #f97316);
        transition: width 0.9s linear;
      }
      .timer-label {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 0.4rem;
      }
      .status-ok {
        color: #22c55e;
      }
      .status-error {
        color: #f97316;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.8rem;
        background: #020617;
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
      }
    </style>
  </head>
  <body>
    <h1>Tropico Ventures IOT Test Dashboard</h1>
    <h2>
      Para ver las variables medidas directamente de los sensores antes de enviarlas a la nube.
      Este panel es solo para depuración y puesta en marcha: en producción la Pico2W solo enviará
      datos a la nube y el webserver no debería correr de forma permanente.
    </h2>

    <div class="grid">
      <div class="card">
        <h3>Lecturas del SCD41 (CO₂ / T / RH)</h3>
        <p class="metric">
          CO₂:
          <span id="co2" class="value">--</span>
          <span class="unit">ppm</span>
        </p>
        <p class="metric">
          Temperatura:
          <span id="temp" class="value">--</span>
          <span class="unit">°C</span>
        </p>
        <p class="metric">
          Humedad relativa:
          <span id="rh" class="value">--</span>
          <span class="unit">%rH</span>
        </p>
        <p class="metric">
          Última actualización:
          <span id="last-update" class="value">--:--:--</span>
        </p>
      </div>

      <div class="card">
        <h3>Timer de muestreo (cada 5&nbsp;s)</h3>
        <p class="metric">
          Estado:
          <span id="status" class="status-error">Esperando primera lectura…</span>
        </p>
        <div class="timer-bar">
          <div id="timer-fill" class="timer-bar-fill"></div>
        </div>
        <div id="timer-label" class="timer-label">
          Próxima actualización en ~5&nbsp;s.
        </div>
        <p class="timer-label">
          El navegador pide <code>/data</code> al servidor de la Pico2W cada
          5&nbsp;segundos y este responde con las últimas lecturas del sensor.
        </p>
      </div>
    </div>

    <script>
      const co2El = document.getElementById("co2");
      const tempEl = document.getElementById("temp");
      const rhEl = document.getElementById("rh");
      const lastUpdateEl = document.getElementById("last-update");
      const statusEl = document.getElementById("status");
      const timerFillEl = document.getElementById("timer-fill");
      const timerLabelEl = document.getElementById("timer-label");

      let seconds = 0;
      const PERIOD = 5; // segundos

      function tickTimer() {
        seconds = (seconds + 1) % PERIOD;
        const fraction = seconds / PERIOD;
        timerFillEl.style.width = (fraction * 100).toFixed(0) + "%";
        timerLabelEl.textContent =
          "Han transcurrido " + seconds + " s desde la última petición.";
      }

      function updateData() {
        fetch("/data")
          .then((response) => response.json())
          .then((data) => {
            if (data && data.co2 != null) {
              co2El.textContent = data.co2.toFixed(0);
              tempEl.textContent = data.temp.toFixed(1);
              rhEl.textContent = data.rh.toFixed(1);
              const now = new Date();
              lastUpdateEl.textContent = now.toLocaleTimeString();
              statusEl.textContent = "Lecturas OK";
              statusEl.className = "status-ok";
            } else {
              statusEl.textContent = "Sin datos válidos del sensor";
              statusEl.className = "status-error";
            }
            // reiniciar timer visual
            seconds = 0;
            timerFillEl.style.width = "0%";
          })
          .catch((err) => {
            console.log("Error al pedir /data:", err);
            statusEl.textContent = "Error de comunicación con la Pico2W";
            statusEl.className = "status-error";
          });
      }

      // Timer de 1 s para la animación y de 5 s para pedir datos
      setInterval(tickTimer, 1000);
      setInterval(updateData, PERIOD * 1000);

      // Primera carga inmediata
      updateData();
    </script>
  </body>
</html>
